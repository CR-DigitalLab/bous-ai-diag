// „Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„Å´„ÉÅ„É£„Éº„Éà„Ç§„É≥„Çπ„Çø„É≥„Çπ„Çí‰øùÊåÅ„Åô„ÇãÂ§âÊï∞„ÇíÂÆöÁæ©
let myRadarChart = null;

function diagnose() {
    // --- 1. ÂÖ•ÂäõÂÄ§„ÅÆÂèñÂæó ---
    const adults = parseInt(document.getElementById('adults').value) || 0;
    const children = parseInt(document.getElementById('children').value) || 0;
    const totalPeople = adults + children;
    if (totalPeople === 0) {
        alert("‰∫∫Êï∞„Çí1‰∫∫‰ª•‰∏äÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
        return;
    }

    // È£üÊñô„ÉªÊ∞¥
    const water = parseFloat(document.getElementById('water').value) || 0;
    const food = parseInt(document.getElementById('food').value) || 0;
    const hasPurifier = document.getElementById('purifier').checked;

    // Ë°õÁîü
    const toiletPaper = parseInt(document.getElementById('toilet-paper').value) || 0;
    const hasPortableToilet = document.getElementById('portable-toilet').checked;
    const hasWetWipes = document.getElementById('wet-wipes').checked;
    const hasToothbrush = document.getElementById('toothbrush').checked;
    const hasSoap = document.getElementById('soap').checked;
    const hasDryShampoo = document.getElementById('dry-shampoo').checked;
    const hasMask = document.getElementById('mask').checked;

    // ÈõªÂäõ„ÉªÁÖßÊòé„ÉªÊÉÖÂ†±
    const hasBattery = document.getElementById('battery').checked;
    const hasFlashlight = document.getElementById('flashlight').checked;
    const hasDryCell = document.getElementById('dry-cell').checked;
    const hasRadio = document.getElementById('radio').checked;
    
    // Âø´ÈÅ©„ÉªÂÆâÂÖ®
    const hasGasStove = document.getElementById('gas-stove').checked;
    const hasFirstAid = document.getElementById('first-aid').checked;
    const hasGloves = document.getElementById('gloves').checked;
    const hasSleepingBag = document.getElementById('sleeping-bag').checked;
    const hasMedicine = document.getElementById('medicine').checked;
    const hasSaranWrap = document.getElementById('saran-wrap').checked;
    const hasGumTape = document.getElementById('gum-tape').checked;
    const hasCash = document.getElementById('cash').checked;
    const hasEarPlugs = document.getElementById('ear-plugs').checked;
    const hasEntertainment = document.getElementById('entertainment').checked;


    // --- 2. ÁîüÂ≠òÂèØËÉΩÊó•Êï∞„ÅÆË®àÁÆó ---
    const requiredWaterPerDay = adults * 3 + children * 2;
    const requiredFoodPerDay = adults * 3 + children * 3;
    
    let waterDays = requiredWaterPerDay > 0 ? Math.floor(water / requiredWaterPerDay) : 999;
    const foodDays = requiredFoodPerDay > 0 ? Math.floor(food / requiredFoodPerDay) : 999;
    
    if (hasPurifier) {
        waterDays += 21;
    }
    
    const survivalDays = Math.min(waterDays, foodDays);

    // --- 3. „É¨„Éº„ÉÄ„Éº„ÉÅ„É£„Éº„ÉàÁî®„Çπ„Ç≥„Ç¢Ë®àÁÆó (ÂêÑ100ÁÇπÊ∫ÄÁÇπ) ---
    // È£üÊñô„ÉªÊ∞¥
    let foodWaterScore = Math.min(survivalDays / 7, 1) * 80 + (hasPurifier ? 20 : 0);
    if (foodWaterScore > 100) foodWaterScore = 100;

    // Ë°õÁîü
    let hygieneScore = 0;
    if (toiletPaper / totalPeople >= 12) hygieneScore += 20;
    if (hasPortableToilet) hygieneScore += 35; // ÊúÄÈáçË¶Å
    if (hasWetWipes) hygieneScore += 10;
    if (hasToothbrush) hygieneScore += 10;
    if (hasSoap) hygieneScore += 10;
    if (hasDryShampoo) hygieneScore += 5;
    if (hasMask) hygieneScore += 10;

    // ÈõªÂäõ„ÉªÁÖßÊòé
    let powerScore = 0;
    if(hasBattery) powerScore += 50;
    if(hasFlashlight) powerScore += 30;
    if(hasDryCell) powerScore += 20;
    
    // ÊÉÖÂ†±
    let infoScore = hasRadio ? 100 : 0;
    
    // Âø´ÈÅ©„ÉªÂÆâÂÖ®
    let comfortScore = 0;
    if (hasGasStove) comfortScore += 20;
    if (hasFirstAid) comfortScore += 15;
    if (hasGloves) comfortScore += 5;
    if (hasSleepingBag) comfortScore += 15;
    if (hasMedicine) comfortScore += 10;
    if (hasSaranWrap) comfortScore += 10;
    if (hasGumTape) comfortScore += 8;
    if (hasCash) comfortScore += 5;
    if (hasEarPlugs) comfortScore += 7;
    if (hasEntertainment) comfortScore += 5;


    // --- 4. Èò≤ÁÅΩ„Çø„Ç§„ÉóÁß∞Âè∑„ÅÆÊ±∫ÂÆö ---
    let title = "";
    const avgScore = (hygieneScore + powerScore + infoScore + comfortScore) / 4;

    if (survivalDays >= 7 && foodWaterScore >= 95 && hygieneScore < 50) {
        title = "ÁæéÈ£üÂÆ∂„Çµ„Éê„Ç§„Éê„Éº";
    } else if (survivalDays >= 7 && powerScore >= 95 && foodWaterScore < 50) {
        title = "„Ç¨„Ç∏„Çß„ÉÉ„ÉàÁ±†ÂüéËÄÖ";
    } else if (survivalDays >= 7 && hygieneScore >= 95 && comfortScore < 50) {
        title = "ÊΩîÁôñÁóá„Çµ„Éê„Ç§„Éê„Éº";
    } else {
        if (survivalDays >= 30 && avgScore >= 95) {
            title = "Èò≤ÁÅΩÁ•û üëë";
        } else if (survivalDays >= 30 && avgScore >= 80) {
            title = "Â≠§È´ò„ÅÆ„Çµ„Éê„Ç§„Éê„É™„Çπ„Éà";
        } else if (survivalDays >= 30 && avgScore >= 60) {
            title = "Èï∑ÊúüÁ±†Âüé„ÅÆÈÅî‰∫∫";
        } else if (survivalDays >= 21 && avgScore >= 85) {
            title = "Èò≤ÁÅΩ„Ç®„É™„Éº„Éà";
        } else if (survivalDays >= 21 && avgScore >= 70) {
            title = "ÂÜ∑Èùô„Å™Êà¶Áï•ÂÆ∂";
        } else if (survivalDays >= 14 && avgScore >= 75) {
            title = "Âë®Âà∞„Å™Ê∫ñÂÇôÂÆ∂";
        } else if (survivalDays >= 14 && avgScore >= 60) {
            title = "È†º„Çå„Çã„ÅîËøëÊâÄ„Åï„Çì";
        } else if (survivalDays >= 7 && avgScore >= 60) {
            title = "ÂÇô„Åà„ÅÇ„ÇãÂ∏ÇÊ∞ë";
        } else if (survivalDays >= 7 && avgScore >= 40) {
            title = "‰∏çÂÆâ„Å™‰∏ÄÈÄ±Èñì";
        } else if (survivalDays >= 3 && avgScore >= 40) {
            title = "„ÇÆ„É™„ÇÆ„É™ÁîüÂ≠ò„É©„Ç§„É≥";
        } else if (survivalDays >= 3 && avgScore >= 20) {
            title = "ÂÇôËìÑÊ¨†‰πèÁóá";
        } else if (survivalDays < 3) {
            title = "Èò≤ÁÅΩ„Å≤„Çà„Å£„Åì";
        } else {
            title = "ÂàÜÈ°û‰∏çËÉΩ„Å™„Çµ„Éê„Ç§„Éê„Éº";
        }
    }


    // --- 5. „Ç¢„Éâ„Éê„Ç§„Çπ„Å®Ë≤∑„ÅÑÁâ©„É™„Çπ„Éà„ÅÆÁîüÊàê ---
    const adviceList = document.getElementById('advice-list');
    adviceList.innerHTML = '';
    const shoppingList = [];
    let adviceFound = false;

    const addSuggestion = (adviceText, needs, shoppingItem) => {
        const li = document.createElement('li');
        li.innerText = adviceText;
        adviceList.appendChild(li);
        adviceFound = true;
        if (needs && shoppingItem) {
            shoppingList.push(shoppingItem);
        }
    };

    if (survivalDays < 7) {
        if (waterDays < 7 && foodDays < 7) {
            addSuggestion("Ê∞¥„Å®È£üÊñô„Åå1ÈÄ±ÈñìÂàÜ„Å´Ê∫Ä„Åü„Å™„ÅÑ„Çà„ÅÜ„Åß„Åô„ÄÇÂëΩ„Å´Áõ¥Áµê„Åô„Çã„Åü„ÇÅÊúÄÂÑ™ÂÖà„ÅßÂÇôËìÑ„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ", true, {name: "ÂÇôËìÑÊ∞¥„ÉªÈ£üÊñô", query: "Èò≤ÁÅΩ ÂÇôËìÑ È£üÊñô 7Êó•"});
        } else if (waterDays < 7) {
            addSuggestion("È£üÊñô„Å´ÊØî„Åπ„ÄÅÈ£≤ÊñôÊ∞¥„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ1‰∫∫1Êó•3L„ÇíÁõÆÂÆâ„Å´Á¢∫‰øù„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ", true, {name: "È£≤ÊñôÊ∞¥ 2L", query: "Ê∞¥ 2l ÂÇôËìÑ"});
        } else {
            addSuggestion("Ê∞¥„ÅØÂçÅÂàÜ„Åß„Åô„Åå„ÄÅÈ£üÊñô„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ„É≠„Éº„É™„É≥„Ç∞„Çπ„Éà„ÉÉ„ÇØ„Å™„Å©„ÇíÊ¥ªÁî®„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ", true, {name: "ÈùûÂ∏∏È£ü „É≠„Éº„É™„É≥„Ç∞„Çπ„Éà„ÉÉ„ÇØ", query: "ÈùûÂ∏∏È£ü „É≠„Éº„É™„É≥„Ç∞„Çπ„Éà„ÉÉ„ÇØ"});
        }
    }
    if (survivalDays < 30 && !hasPurifier) {
        addSuggestion("Êê∫Â∏ØÊµÑÊ∞¥Âô®„Åå„ÅÇ„Çå„Å∞„ÄÅÈ£≤„ÇÅ„ÇãÊ∞¥„ÅÆÈÅ∏ÊäûËÇ¢„ÅåÂ¢ó„ÅàÁîüÂ≠òÁéá„ÅåÈ£õË∫çÁöÑ„Å´Âêë‰∏ä„Åó„Åæ„Åô„ÄÇ", !hasPurifier, {name: "Êê∫Â∏ØÊµÑÊ∞¥Âô®", query: "Èò≤ÁÅΩ Êê∫Â∏ØÊµÑÊ∞¥Âô®"});
    }
    if (!hasPortableToilet) {
        addSuggestion("ÁÅΩÂÆ≥ÊôÇ„Å´ÊúÄ„ÇÇÂõ∞„Çã„ÅÆ„Åå„Éà„Ç§„É¨„Åß„Åô„ÄÇÁ∞°Êòì„Éà„Ç§„É¨„ÅØË°õÁîü„Å®Â∞äÂé≥„ÇíÂÆà„ÇãÂøÖÈúÄÂìÅ„Åß„Åô„ÄÇ", !hasPortableToilet, {name: "Á∞°Êòì„Éà„Ç§„É¨", query: "Èò≤ÁÅΩ Á∞°Êòì„Éà„Ç§„É¨"});
    }
    if (!hasSaranWrap) {
        addSuggestion("„Çµ„É©„É≥„É©„ÉÉ„Éó„ÅØÈ£üÂô®„ÇíÊ±ö„Åï„ÅöÁØÄÊ∞¥„Å´„Å™„Çã‰ªñ„ÄÅÈò≤ÂØí„ÇÑÂøúÊÄ•Âá¶ÁΩÆ„Å´„ÇÇ‰Ωø„Åà„Çã‰∏áËÉΩÂìÅ„Åß„Åô„ÄÇ", !hasSaranWrap, {name: "„Çµ„É©„É≥„É©„ÉÉ„Éó", query: "„Çµ„É©„É≥„É©„ÉÉ„Éó 30cm"});
    }
    if (!hasBattery) {
        addSuggestion("ÊÉÖÂ†±ÂèéÈõÜ„ÇÑÈÄ£Áµ°„Å´ÂøÖÈ†à„ÅÆ„Çπ„Éû„Éõ„ÇíÂÆà„Çã„Åü„ÇÅ„ÄÅÂ§ßÂÆπÈáè„É¢„Éê„Ç§„É´„Éê„ÉÉ„ÉÜ„É™„Éº„ÇíÊ∫ñÂÇô„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ", !hasBattery, {name: "„É¢„Éê„Ç§„É´„Éê„ÉÉ„ÉÜ„É™„Éº", query: "Èò≤ÁÅΩ „É¢„Éê„Ç§„É´„Éê„ÉÉ„ÉÜ„É™„Éº Â§ßÂÆπÈáè"});
    }
    if (!hasRadio) {
        addSuggestion("„Çπ„Éû„Éõ„Åå‰Ωø„Åà„Å™„ÅÑÁä∂Ê≥Å„ÇÇÊÉ≥ÂÆö„Åó„ÄÅÈõªÊ±†‰∏çË¶Å„ÅÆÊâãÂõû„ÅóÂÖÖÈõª„É©„Ç∏„Ç™„ÅßÊÉÖÂ†±„ÇíÁ¢∫‰øù„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ", !hasRadio, {name: "Èò≤ÁÅΩ„É©„Ç∏„Ç™", query: "Èò≤ÁÅΩ„É©„Ç∏„Ç™ ÊâãÂõû„Åó"});
    }
    if (!hasCash) {
        addSuggestion("ÂÅúÈõª„Å´ÂÇô„Åà„ÄÅÈõªÂ≠ê„Éû„Éç„Éº„Å´È†º„Çâ„Å™„ÅÑÁèæÈáëÔºàÁâπ„Å´Â∞èÈä≠Ôºâ„ÇíÁî®ÊÑè„Åó„Å¶„Åä„Åç„Åæ„Åó„Çá„ÅÜ„ÄÇ", !hasCash, null);
    }
    if (!hasEntertainment) {
        addSuggestion("Èï∑Êúü„ÅÆÈÅøÈõ£ÁîüÊ¥ª„Åß„ÅØÂøÉ„ÅÆÂÅ•Â∫∑„ÇÇÈáçË¶Å„ÄÇÈõªÊ∞ó‰∏çË¶Å„ÅÆÂ®ØÊ•ΩÂìÅÔºàÊú¨„ÇÑ„Ç´„Éº„Éâ„Ç≤„Éº„É†„Å™„Å©Ôºâ„ÅåÂΩπÁ´ã„Å°„Åæ„Åô„ÄÇ", !hasEntertainment, {name: "Â®ØÊ•ΩÂìÅ (Êú¨„Éª„Ç≤„Éº„É†„Å™„Å©)", query: "„Éú„Éº„Éâ„Ç≤„Éº„É†"});
    }

    if (!adviceFound) {
        const li = document.createElement('li');
        li.innerText = "Á¥†Êô¥„Çâ„Åó„ÅÑÂÇô„Åà„Åß„ÅôÔºÅ„Åª„ÅºÂÆåÁíß„Å®Ë®Ä„Åà„Çã„Åß„Åó„Çá„ÅÜ„ÄÇ„Åì„ÅÆÈò≤ÁÅΩÊÑèË≠ò„ÇíÁ∂≠ÊåÅ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
        adviceList.appendChild(li);
    }
    
    // --- 6. ÁµêÊûú„ÅÆË°®Á§∫ ---
    const resultArea = document.getElementById('result-area');
    resultArea.style.display = 'block';
    
    document.getElementById('bousai-title').innerText = title;
    document.getElementById('survival-days').innerText = survivalDays;

    const shoppingListUl = document.getElementById('shopping-list');
    shoppingListUl.innerHTML = '';
    if(shoppingList.length > 0) {
        const uniqueShoppingList = [...new Map(shoppingList.map(item => [item.name, item])).values()];
        uniqueShoppingList.forEach(item => {
            const li = document.createElement('li');
            li.innerHTML = `${item.name} <a href="https://www.amazon.co.jp/s?k=${encodeURIComponent(item.query)}" target="_blank" rel="noopener noreferrer">(Amazon„ÅßÊé¢„Åô)</a>`;
            shoppingListUl.appendChild(li);
        });
    } else {
         const li = document.createElement('li');
         li.innerText = "Á¥†Êô¥„Çâ„Åó„ÅÑÔºÅÂøÖÈúÄÂìÅ„Å´Â§ß„Åç„Å™‰∏çË∂≥„ÅØ„Å™„Åï„Åù„ÅÜ„Åß„Åô„ÄÇ";
         shoppingListUl.appendChild(li);
    }

    // --- 7. „É¨„Éº„ÉÄ„Éº„ÉÅ„É£„Éº„Éà„ÅÆÊèèÁîª ---
    const chartScores = [
        { name: 'È£üÊñô„ÉªÊ∞¥', score: foodWaterScore },
        { name: 'Ë°õÁîü', score: hygieneScore },
        { name: 'ÈõªÂäõ', score: powerScore },
        { name: 'ÊÉÖÂ†±', score: infoScore },
        { name: 'Âø´ÈÅ©„ÉªÂÆâÂÖ®', score: comfortScore }
    ];

    const ctx = document.getElementById('radar-chart').getContext('2d');
    
    if (myRadarChart) myRadarChart.destroy();

    myRadarChart = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: chartScores.map(s => s.name),
            datasets: [{
                label: 'Èò≤ÁÅΩ„Çπ„Ç≥„Ç¢',
                data: chartScores.map(s => s.score),
                // ‚ñº Ë¶ã„ÇÑ„Åô„ÅÑ„Çà„ÅÜ„Å´ÈÖçËâ≤„Çí„ÉÜ„Éº„Éû„Å´Âêà„Çè„Åõ„Çã
                backgroundColor: 'rgba(0, 255, 0, 0.3)', // ËõçÂÖâ„Ç∞„É™„Éº„É≥„ÅÆÂçäÈÄèÊòé
                borderColor: '#00ff00', // ËõçÂÖâ„Ç∞„É™„Éº„É≥
                pointBackgroundColor: '#00ff00', // ËõçÂÖâ„Ç∞„É™„Éº„É≥
                pointBorderColor: '#1a1a1a', // „Éù„Ç§„É≥„Éà„ÅÆ„Éï„ÉÅ„ÇíËÉåÊôØËâ≤„Å´
                pointHoverBackgroundColor: '#fff', // „Éõ„Éê„ÉºÊôÇ„ÅÆËâ≤
                pointHoverBorderColor: '#00ff00' // „Éõ„Éê„ÉºÊôÇ„ÅÆ„Éï„ÉÅ„ÅÆËâ≤
            }]
        },
        options: {
            scales: {
                r: {
                    // ‚ñº Á∑ö„ÅÆËâ≤„ÇíÊòé„Çã„Åè„Åô„Çã
                    angleLines: {
                        color: '#666' // „ÇÑ„ÇÑÊòé„Çã„ÅÑ„Ç∞„É¨„Éº
                    },
                    // ‚ñº „Ç∞„É™„ÉÉ„ÉâÁ∑ö„ÅÆËâ≤„ÇíÊòé„Çã„Åè„Åô„Çã
                    grid: {
                        color: '#666' // „ÇÑ„ÇÑÊòé„Çã„ÅÑ„Ç∞„É¨„Éº
                    },
                    // ‚ñº Ëª∏„É©„Éô„É´„ÅÆ„Éï„Ç©„É≥„ÉàË®≠ÂÆö
                    pointLabels: {
                        font: {
                            size: 14
                        },
                        color: '#e0e0e0' // „Ç¥„Éº„Çπ„Éà„Éõ„ÉØ„Ç§„Éà
                    },
                    // ‚ñº ÁõÆÁõõ„Çä„ÅÆÊï∞Â≠ó„ÅÆË®≠ÂÆö
                    ticks: {
                        color: '#e0e0e0', // „Ç¥„Éº„Çπ„Éà„Éõ„ÉØ„Ç§„Éà
                        backdropColor: 'rgba(42, 42, 42, 0.8)' // ËÉåÊôØËâ≤„Çí„Ç≥„É≥„ÉÜ„Éä„Å´Âêà„Çè„Åõ„Çã
                    },
                    suggestedMin: 0,
                    suggestedMax: 100
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // --- 8. SNSÂÖ±Êúâ„Éú„Çø„É≥„ÅÆÊõ¥Êñ∞ ---
    const tweetText = `ÁßÅ„ÅÆÈò≤ÁÅΩ„Çø„Ç§„Éó„ÅØ„Äê${title}„Äë„Åß„Åó„ÅüÔºÅ\nÂÇôËìÑ„Å†„Åë„ÅßÊöÆ„Çâ„Åõ„ÇãÊó•Êï∞„ÅØ„Äê${survivalDays}Êó•„Äë„Åß„Åô„ÄÇ\n\n#BousAI #„Å≤„Åç„Åì„ÇÇ„ÇäÈò≤ÁÅΩË®∫Êñ≠`;
    const tweetUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(tweetText)}&url=${encodeURIComponent(window.location.href)}`;
    document.getElementById('tweet-button').href = tweetUrl;

    resultArea.scrollIntoView({ behavior: 'smooth' });
}